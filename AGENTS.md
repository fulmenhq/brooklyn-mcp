# AGENTS.md: Guidelines for Agentic Coding in fulmen-mcp-forge-brooklyn

## Project Overview

Brooklyn is a multi-team MCP server for browser automation using Bun, TypeScript, and Playwright. Follow fulmen ecosystem standards in docs/fulmen/.

## üö® MANDATORY READING FOR AI AGENTS (READ FIRST!)

**ALL AI AGENTS must read these foundational documents BEFORE any work:**

### **Core Identity & Role Definition (MANDATORY)**

1. **MAINTAINERS.md** - Your specific role, responsibilities, and supervision model
2. **BROOKLYN-SAFETY-PROTOCOLS.md** - Non-negotiable safety requirements

### **Technical Standards (MANDATORY)**

3. **docs/development/standards/coding-standards.md** - The Non-Negotiables (READ THIS FIRST!)
4. **AGENTS.local.md** - Local development configuration and agent-specific guidelines (if present)
5. **package.json** - Available commands and dependencies (ALWAYS read scripts section)
6. **docs/substaile/codex/coding.md** - Core coding principles and error patterns
7. **docs/substaile/codex/typescript/typescript-coding.md** - TypeScript-specific standards

### **Agent Accountability**

- **Integration Lead**: Must understand ALL integration points and team dependencies
- **Spark Process Lead**: Must enforce reading compliance for ALL team members
- **Platform Architect**: Must understand complete technical architecture before any changes

**FAILURE TO READ FOUNDATIONAL DOCS = IMMEDIATE SESSION RESET**

## Build/Lint/Test Commands

- Build: bun run build
- Lint: bun run lint
- Typecheck: bun run typecheck
- Test all: bun run test (vitest - NEVER bun test)
- Test single file: bun run test path/to/test.ts
- Test specific test: bun run test -t "test name"
- Format: bun run format:code
- File check: bun run check:file path/to/file.ts (mandatory after edits)
- Check all: bun run check-all (run before commits)
- Version bump: bun run version:bump:patch (NEVER edit VERSION/package.json manually)

## AI Agent Commit Attribution

AI agent commits should use this format:

```
Generated by [AI Agent Name] under supervision of @[human-maintainer]

Co-Authored-By: [AI Agent Name] <noreply@fulmen.ai>
```

Example:

```
Generated by Paris Brooklyn under supervision of @3leapsdave

Co-Authored-By: Paris Brooklyn <noreply@fulmen.ai>
```

## AI Agent Communication Standards

### Email Signature Format

```
---
[AI Agent Name]
AI Co-Maintainer, Fulmen MCP Forge Brooklyn
Supervised by @[human-maintainer]
[agent-name]@fulmenhq.com
```

### Chat/Mattermost Signature Format

```
‚Äî[AI Agent Name] (AI Co-Maintainer supervised by @[human-maintainer])
```

### GitHub Communication Format

```
---
*[AI Agent Name] - AI Co-Maintainer supervised by @[human-maintainer]*
```

### Communication Requirements

- **Always identify as AI agent** in first contact with new team members
- **Include supervision attribution** in all formal communications
- **Use consistent signatures** across email, chat, GitHub, and other platforms
- **Maintain transparency** about AI nature while being professional
- **Defer to human supervisor** for policy decisions and governance matters

## Code Style Guidelines (Quick Reference)

### üö® CRITICAL - Will Break Production

- **NEVER** initialize loggers at module level - use lazy initialization pattern
- **ALWAYS** use `InValue[]` for database parameters (not `any[]` or `unknown[]`)
- **ALWAYS** use bracket notation for database results: `row["field"]` not `row.field`

### üéØ MANDATORY - Will Fail Linting

- **Strings**: `"double quotes"` for simple, `` `backticks` `` ONLY for templates with `${vars}`
- **Environment**: `process.env["VAR"]` never `process.env.VAR`
- **Imports**: Node ‚Üí Third-party ‚Üí Local (with blank lines); use `import type`
- **Types**: NO `any` (use `unknown`); NO `!` in tests (use `?.`)
- **Promises**: `Promise<T | undefined>` not `Promise<T | void>`
- **Testing**: `bun run test` (vitest) NEVER `bun test`

### üìã File Validation (After Every Edit)

```bash
bun run check:file:fix path/to/file.ts  # Auto-fix what's possible
bun run check:file path/to/file.ts      # Verify all checks pass
```

**Full details**: See `docs/development/standards/coding-standards.md`

- **Error Handling**: Structured logging; try-catch for async; no silent failures; error boundaries
- **General**: Template literals; process.env["VAR"]; single responsibility; JSDoc for APIs
- **Testing**: AAA pattern; independent tests; 80%+ coverage; proper mocks; vitest only
- **Security**: Domain validation, rate limiting, team isolation
- **Cursor/Copilot Rules**: None found - follow above standards

## Development Standards

- Source-first: Review existing code before changes
- Pattern consistency: Follow codebase patterns
- Quality gates: All checks must pass; no bypassing
- MCP Compliance: Strict protocol adherence
- Resource Mgmt: Browser pooling, cleanup
- Planning docs: .plans/ directory is gitignored - use for team coordination, not permanent docs

## üö® MANDATORY SAFETY PROTOCOLS COMPLIANCE

**ALL TEAM MEMBERS AND AI AGENTS** must read and explicitly acknowledge compliance with the comprehensive safety protocols before participating in Brooklyn operations.

### üìã **REQUIRED READING**

**PRIMARY DOCUMENT**: [`BROOKLYN-SAFETY-PROTOCOLS.md`](./BROOKLYN-SAFETY-PROTOCOLS.md)

This document contains the complete, authoritative safety protocols for all Brooklyn MCP operations. It includes:

- üåâ Browser automation danger classification (Level 1-3)
- üõ°Ô∏è Mandatory safety protocols (6 core protocols)
- üéØ MCP safety architecture
- üß† AI agent behavioral requirements
- üåê Browser automation safety patterns
- üìã Mandatory compliance acknowledgment

### ‚úÖ **EXPLICIT COMPLIANCE REQUIRED**

Before proceeding with ANY Brooklyn browser automation, you must:

1. **READ** the complete `BROOKLYN-SAFETY-PROTOCOLS.md` document
2. **UNDERSTAND** all 6 mandatory safety protocols
3. **ACKNOWLEDGE** the behavioral requirements for AI agents
4. **CONFIRM** your compliance by completing the digital signature section

### üö® **NON-NEGOTIABLE REQUIREMENTS**

The safety protocols are **MANDATORY** and **NON-NEGOTIABLE**. Key highlights include:

- **Commit quality gates** - all commits must pass typecheck, lint, and tests
- **No --no-verify** without explicit maintainer approval
- **Never chain browser operations** with `&&` or `;`
- **Explicit user authorization** required for all browser automation
- **Domain validation** for all automation operations
- **Atomic operation execution** - one logical automation per MCP tool
- **Resource cleanup** with verified browser instance management

## üö® CRITICAL: Logger Initialization Pattern (WILL BREAK BUNDLED APPS)

**THIS IS THE #1 CAUSE OF BUNDLED BINARY FAILURES**

### ‚ùå NEVER DO THIS - Module-Level Logger

```typescript
import { getLogger } from "../shared/structured-logger.js";
const logger = getLogger("my-module"); // üí• EXECUTES DURING BUNDLE!
```

### ‚úÖ ALWAYS DO THIS - Lazy Logger Pattern

```typescript
let logger: ReturnType<typeof getLogger> | null = null;
function ensureLogger() {
  if (!logger) {
    logger = getLogger("my-module");
  }
  return logger;
}
// Use: ensureLogger().info("Safe!");
```

**See docs/development/logging_and_telemetry_guide.md for full details**

## Pre-Commit Quality Gates (MANDATORY)

**ZERO-TOLERANCE POLICY**: All quality gates must pass before commit. Only maintainer can approve `--no-verify` for emergency situations.

### Required Checks (All Must Pass)

```bash
# 1. Code quality and tests
bun run check-all                    # Format, typecheck, lint, tests (100/100)

# 2. Build and install
bun run build                        # Must complete without errors
bun run install                      # Global CLI installation must succeed

# 3. Functional verification
brooklyn status                      # CLI must be functional
bun run dev:brooklyn:start           # Local dev mode must start
bun run dev:brooklyn:stop            # Local dev mode must stop cleanly
```

### Commit Approval Criteria

- ‚úÖ **Code Quality**: All linting, formatting, type checking passes
- ‚úÖ **Test Suite**: 100% test pass rate (no skipped/failing tests)
- ‚úÖ **Build Success**: Clean build with no errors or warnings
- ‚úÖ **CLI Functional**: `brooklyn status` and basic commands work
- ‚úÖ **Dev Mode**: Local development mode starts/stops correctly
- ‚úÖ **Attribution Format**: Must follow Fulmen Spark attribution standards (see below)

## üöÄ Fulmen Spark Commit Attribution Standards

**MANDATORY**: All AI agent commits must use the standardized Fulmen attribution format.

### Required Format

```
<type>: <description>

<body with bullet points describing changes>

Generated by [AI Agent Name] ([Specialization]) under supervision of @3leapsdave

Co-Authored-By: [AI Agent Name] <noreply@fulmen.ai>
```

### Example Commit Messages

#### **MCP Platform Architecture**

```
feat: implement enterprise browser pool management

- Add intelligent browser allocation system
- Implement cleanup on process termination
- Create resource monitoring and health checks
- Update team configuration isolation

Generated by Paris Brooklyn (MCP Platform Architect) under supervision of @3leapsdave

Co-Authored-By: Paris Brooklyn <noreply@fulmen.ai>
```

#### **Infrastructure & System Design**

```
refactor: optimize enterprise logging infrastructure

- Migrate from structured-logger to Pino for performance
- Implement silent initialization for MCP mode
- Add file-based logging with rotation
- Update telemetry integration patterns

Generated by Architect Brooklyn (Enterprise Infrastructure Lead) under supervision of @3leapsdave

Co-Authored-By: Architect Brooklyn <noreply@fulmen.ai>
```

### Attribution Requirements

1. **Conventional Commit Type**: `feat:`, `fix:`, `docs:`, `chore:`, etc.
2. **Clear Description**: Concise summary of changes
3. **Bullet Point Body**: List of specific changes made
4. **Enhanced AI Attribution**: `Generated by [AI Agent Name] ([Specialization]) under supervision of @3leapsdave`
5. **Co-Author Line**: `Co-Authored-By: [AI Agent Name] <noreply@fulmen.ai>`
6. **Specialization Context**: Include role specialization in parentheses for clarity

### ‚ùå Do NOT Use These Formats

**Generic Claude Code Format** (Deprecated):

```
ü§ñ Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

**OpenCode Format** (Not applicable):

```
ü§ñ Generated with opencode

Co-Authored-By: opencode <noreply@opencode.ai>
```

### ‚úÖ Always Use Fulmen Format

- **AI Agent Name**: "Paris Brooklyn" (full project identity)
- **Supervision**: "@3leapsdave" (human maintainer GitHub handle)
- **Email Domain**: `noreply@fulmen.ai` (Fulmen standard)
- **Consistency**: Same name and format across all commits

### Validation Checklist

Before committing, verify:

- [ ] Conventional commit type used (`feat:`, `fix:`, etc.)
- [ ] Clear, descriptive commit message
- [ ] Bullet points describing specific changes
- [ ] "Generated by Paris Brooklyn under supervision of @3leapsdave" line
- [ ] "Co-Authored-By: Paris Brooklyn <noreply@fulmen.ai>" line
- [ ] No generic Claude/OpenCode attribution used

### Emergency Override

**Only maintainer (@3leapsdave) can approve**:

```bash
git commit --no-verify -m "EMERGENCY/URGENT/INTEGRATION - [reason]"
```

**See BROOKLYN-SAFETY-PROTOCOLS.md Emergency Fix Process for complete procedures:**

- Level 1: Critical System Down (implied approval for restoration)
- Level 2: Urgent Bug Fix (rapid approval process)
- Level 3: Integration Cycle (planned override for long cycles)

**All emergency overrides require immediate follow-up with quality restoration.**

**Reference**: See `docs/fulmen/spark/commit-attribution.md` for complete Fulmen Spark standards.

**Note**: Read source first, run quality gates before commits. See docs/substaile/codex/ for details. For onboarding, see CLAUDE.md.
