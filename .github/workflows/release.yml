name: Release

on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*-*"

permissions:
  contents: write

jobs:
  # Pre-release validation job
  validate-release:
    name: Validate Release Readiness
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.validation.outputs.ready }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install browsers for E2E tests
        run: bun run setup:browsers

      - name: Setup test infrastructure
        run: bun run setup:test-infra

      - name: Run Release Validation
        id: validation
        run: |
          echo "üîç Running comprehensive release validation..."
          bun run release:validate
          echo "ready=true" >> $GITHUB_OUTPUT

  # Cross-platform build job
  build-and-release:
    name: Build and Release (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: validate-release
    if: needs.validate-release.outputs.ready == 'true'
    strategy:
      fail-fast: false
      matrix:
        # Temporarily disabled windows-latest while fixing dependency updates and CI issues
        os: [ubuntu-latest, macos-latest]
        # os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Windows build tools
        if: runner.os == 'Windows'
        run: |
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
          Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression
          echo "$env:USERPROFILE\scoop\shims" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          scoop install zip shasum
        shell: pwsh

      - name: Verify Windows tools
        if: runner.os == 'Windows'
        run: |
          zip --version
          shasum --version
          tar --version
        shell: pwsh

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install browsers for E2E tests
        run: bun run setup:browsers

      - name: Setup test infrastructure
        run: bun run setup:test-infra

      - name: Build Local Binary (Required for Tests)
        run: |
          echo "üî® Building local binary for test dependencies..."
          bun run build:local

      - name: Run Quality Gates
        run: |
          echo "üîç Running pre-release quality gates..."
          bun run check-all

      - name: Build All Platforms
        run: |
          echo "üî® Building all platform binaries..."
          bun run build:all

      - name: Package All Artifacts
        run: |
          echo "üì¶ Creating distribution artifacts..."
          bun run package:all

      - name: License Compliance Check
        run: |
          echo "üìÑ Verifying license compliance..."
          bun run license:scan:strict

      - name: Upload artifacts to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/release/*.zip
            dist/release/*.tar.gz
            dist/release/SHA256SUMS_*.txt
            dist/release/licenses.json
            dist/release/THIRD_PARTY_NOTICES.md
          fail_on_unmatched_files: false
          overwrite: true
          body: |
            ## Brooklyn MCP ${{ github.ref_name }}

            ### What's New
            See [CHANGELOG.md](https://github.com/fulmenhq/brooklyn-mcp/blob/main/CHANGELOG.md) for detailed changes.

            ### Installation
            Download the appropriate binary for your platform and make it executable:

            ```bash
            # Linux/macOS
            chmod +x brooklyn-<platform>-<arch>
            ./brooklyn-<platform>-<arch> --help
            ```

            ### License Compliance
            This release includes:
            - `licenses.json` - Complete dependency license inventory
            - `THIRD_PARTY_NOTICES.md` - Third-party license texts

            ### Verification
            Verify binary integrity using the provided checksums:
            ```bash
            shasum -a 256 -c SHA256SUMS_<platform>_<arch>.txt
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Post-release validation
  post-release-validation:
    name: Post-Release Validation
    runs-on: ubuntu-latest
    needs: [validate-release, build-and-release]
    if: always() && needs.validate-release.outputs.ready == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Verify MCP Server
        run: |
          echo "üîç Verifying MCP server functionality..."
          timeout 30s bun run brooklyn mcp start --help || true
          echo "‚úÖ MCP server verification completed"

      - name: Check Release Assets
        run: |
          echo "üì¶ Verifying release assets..."
          # This would check that all expected files are present
          echo "‚úÖ Release asset verification completed"
