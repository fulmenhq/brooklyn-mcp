name: Release

on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*-*"

permissions:
  contents: write

jobs:
  # Pre-release validation job
  validate-release:
    name: Validate Release Readiness
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.validation.outputs.ready }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install minisign for signature verification
        run: sudo apt-get update && sudo apt-get install -y minisign

      - name: Install goneat via sfetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -sSfL https://github.com/3leaps/sfetch/releases/latest/download/install-sfetch.sh | bash
          ~/.local/bin/sfetch -repo fulmenhq/goneat -tag v0.5.2 -install
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Verify goneat installation (minimum v0.5.2)
        run: |
          set -euo pipefail
          goneat --version
          # Verify minimum version v0.5.2 (required for tools.yaml min_version field)
          GONEAT_VERSION=$(goneat --version 2>&1 | head -n1 | \
            grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          REQUIRED_VERSION="v0.5.2"
          OLDEST=$(printf '%s\n' "$REQUIRED_VERSION" "$GONEAT_VERSION" | sort -V | head -n1)
          if [ "$OLDEST" != "$REQUIRED_VERSION" ]; then
            echo "❌ goneat $GONEAT_VERSION is below minimum required $REQUIRED_VERSION"
            exit 1
          fi
          echo "✅ goneat $GONEAT_VERSION meets minimum requirement ($REQUIRED_VERSION)"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install browsers for E2E tests
        run: bun run setup:browsers

      - name: Setup test infrastructure
        run: bun run setup:test-infra

      - name: Run Release Validation
        id: validation
        run: |
          echo "Running comprehensive release validation..."
          bun run release:validate
          echo "ready=true" >> "$GITHUB_OUTPUT"

  # Build job - single runner, all platforms (Bun cross-compiles)
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    needs: validate-release
    if: needs.validate-release.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate License Inventory
        run: |
          echo "Generating license inventory..."
          bun run license:scan

      - name: Build Local Binary (Required for Tests)
        run: |
          echo "Building local binary for test dependencies..."
          bun run build:local

      - name: Build All Platforms
        run: |
          echo "Building all platform binaries (cross-compilation)..."
          bun run build:all

      - name: Package All Artifacts
        run: |
          echo "Creating distribution artifacts..."
          bun run package:all

      - name: License Compliance Check
        run: |
          echo "Verifying license compliance..."
          bun run license:scan:strict

      - name: List Release Artifacts
        run: |
          echo "Release artifacts:"
          ls -la dist/release/

      - name: Upload artifacts to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/release/*.zip
            dist/release/*.tar.gz
            dist/release/SHA256SUMS
            dist/release/SHA512SUMS
            dist/release/licenses.json
            dist/release/THIRD_PARTY_NOTICES.md
            dist/release/RELEASE.md
          fail_on_unmatched_files: false
          overwrite_files: true
          body: |
            ## Brooklyn MCP ${{ github.ref_name }}

            ### What's New
            See [CHANGELOG.md](https://github.com/fulmenhq/brooklyn-mcp/blob/main/CHANGELOG.md) for detailed changes.

            ### Installation
            Download the appropriate binary for your platform and make it executable:

            ```bash
            # Linux/macOS
            chmod +x brooklyn-<platform>-<arch>
            ./brooklyn-<platform>-<arch> --help
            ```

            ### Verification

            **Checksums** (unsigned - signing artifacts uploaded separately):
            ```bash
            # Verify file integrity
            shasum -a 256 -c SHA256SUMS
            ```

            **Signed releases** include additional provenance files:
            - `SHA256SUMS.minisig` / `SHA256SUMS.asc` - Signatures
            - `fulmenhq-release-minisign.pub` - Minisign public key
            - `fulmenhq-release-signing-key.asc` - GPG public key

            See RELEASE_CHECKLIST.md in this repo for verification instructions.

            ### License Compliance
            - `licenses.json` - Complete dependency license inventory
            - `THIRD_PARTY_NOTICES.md` - Third-party license texts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Post-release validation
  post-release-validation:
    name: Post-Release Validation
    runs-on: ubuntu-latest
    needs: [validate-release, build-and-release]
    if: needs.validate-release.result == 'success' && needs.build-and-release.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Verify MCP Server
        run: |
          echo "Verifying MCP server functionality..."
          timeout 30s bun run start -- --help || true
          echo "MCP server verification completed"

      - name: Check Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Verifying release assets..."
          gh release view ${{ github.ref_name }} --repo fulmenhq/brooklyn-mcp --json assets --jq '.assets | length'
          echo "Release asset verification completed"
          echo ""
          echo "NOTE: Signing artifacts will be uploaded separately."
          echo "  RELEASE_TAG=${{ github.ref_name }}"
          echo "  make release-download release-sign release-upload"
