name: Release

on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*-*"

permissions:
  contents: write

jobs:
  # Pre-release validation job
  validate-release:
    name: Validate Release Readiness
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.validation.outputs.ready }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install minisign for signature verification
        run: sudo apt-get update && sudo apt-get install -y minisign

      - name: Install goneat via sfetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -sSfL https://github.com/3leaps/sfetch/releases/latest/download/install-sfetch.sh | bash
          ~/.local/bin/sfetch -repo fulmenhq/goneat -tag v0.5.3 -install
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Verify goneat installation (minimum v0.5.3)
        run: |
          set -euo pipefail
          goneat --version
          # Verify minimum version v0.5.3 (required for tools.yaml min_version field)
          GONEAT_VERSION=$(goneat --version 2>&1 | head -n1 | \
            grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          REQUIRED_VERSION="v0.5.3"
          OLDEST=$(printf '%s\n' "$REQUIRED_VERSION" "$GONEAT_VERSION" | sort -V | head -n1)
          if [ "$OLDEST" != "$REQUIRED_VERSION" ]; then
            echo "❌ goneat $GONEAT_VERSION is below minimum required $REQUIRED_VERSION"
            exit 1
          fi
          echo "✅ goneat $GONEAT_VERSION meets minimum requirement ($REQUIRED_VERSION)"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install browsers for E2E tests
        run: bunx playwright install --with-deps chromium --force

      - name: Setup test infrastructure
        run: bun run setup:test-infra

      - name: Run Release Validation
        id: validation
        run: |
          echo "Running comprehensive release validation..."
          bun run release:validate
          echo "ready=true" >> "$GITHUB_OUTPUT"

  # Native matrix build — each platform compiles its own standalone binary
  build:
    name: Build (${{ matrix.name }})
    needs: validate-release
    if: needs.validate-release.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: linux-x64
            binary: brooklyn-linux-amd64
          - os: ubuntu-latest-arm64-s
            name: linux-arm64
            binary: brooklyn-linux-arm64
          - os: macos-15
            name: darwin-arm64
            binary: brooklyn-darwin-arm64
          - os: windows-latest
            name: windows-x64
            binary: brooklyn-windows-amd64.exe
    # windows-arm64: Bun setup action has no ARM64 binary (404).
    # Built natively via release-windows-arm64.yml (manual dispatch).
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build standalone binary
        run: bun run build:local

      - name: Rename binary for release
        run: |
          if [ -f dist/brooklyn.exe ]; then
            mv dist/brooklyn.exe "dist/${{ matrix.binary }}"
          else
            mv dist/brooklyn "dist/${{ matrix.binary }}"
          fi
          ls -lh "dist/${{ matrix.binary }}"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.name }}
          path: dist/${{ matrix.binary }}
          retention-days: 1

  # Collect all platform binaries, package, and create draft release
  collect:
    name: Collect and Release
    runs-on: ubuntu-latest
    needs: [validate-release, build]
    if: needs.validate-release.result == 'success' && needs.build.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: dist/
          merge-multiple: true

      - name: Verify downloaded binaries
        run: |
          echo "Downloaded binaries:"
          ls -lh dist/brooklyn-*
          echo ""
          echo "Expected 4 binaries (linux-x64, linux-arm64, darwin-arm64, windows-x64)"
          echo "Note: windows-arm64 is built separately via release-windows-arm64.yml"
          BINARY_COUNT=$(ls dist/brooklyn-* | wc -l)
          echo "Found: ${BINARY_COUNT}"
          if [ "${BINARY_COUNT}" -lt 4 ]; then
            echo "⚠️  Warning: expected 4 binaries, found ${BINARY_COUNT}"
          fi

      - name: Generate License Inventory
        run: |
          echo "Generating license inventory..."
          bun run license:scan

      - name: Package All Artifacts
        run: |
          echo "Creating distribution artifacts (zip + tar.gz)..."
          bun run package:all

      - name: License Compliance Check
        run: |
          echo "Verifying license compliance..."
          bun run license:scan:strict

      - name: List Release Artifacts
        run: |
          echo "Release artifacts:"
          ls -la dist/release/

      - name: Upload artifacts to Release (draft)
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: |
            dist/release/*.zip
            dist/release/*.tar.gz
            dist/release/SHA256SUMS
            dist/release/SHA512SUMS
            dist/release/licenses.json
            dist/release/THIRD_PARTY_NOTICES.md
            dist/release/RELEASE.md
          fail_on_unmatched_files: false
          overwrite_files: true
          body: |
            ## Brooklyn MCP ${{ github.ref_name }}

            ### What's New
            See [CHANGELOG.md](https://github.com/fulmenhq/brooklyn-mcp/blob/main/CHANGELOG.md) for detailed changes.

            ### Installation
            Download the appropriate binary for your platform and make it executable:

            ```bash
            # Linux/macOS
            chmod +x brooklyn-<platform>-<arch>
            ./brooklyn-<platform>-<arch> --help
            ```

            ### Verification

            **Checksums** (unsigned - signing artifacts uploaded separately):
            ```bash
            # Verify file integrity
            shasum -a 256 -c SHA256SUMS
            ```

            **Signed releases** include additional provenance files:
            - `SHA256SUMS.minisig` / `SHA256SUMS.asc` - Signatures
            - `fulmenhq-release-minisign.pub` - Minisign public key
            - `fulmenhq-release-signing-key.asc` - GPG public key

            See RELEASE_CHECKLIST.md in this repo for verification instructions.

            ### License Compliance
            - `licenses.json` - Complete dependency license inventory
            - `THIRD_PARTY_NOTICES.md` - Third-party license texts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Post-release validation
  post-release-validation:
    name: Post-Release Validation
    runs-on: ubuntu-latest
    needs: [validate-release, collect]
    if: needs.validate-release.result == 'success' && needs.collect.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Verify MCP Server
        run: |
          echo "Verifying MCP server functionality..."
          timeout 30s bun run start -- --help || true
          echo "MCP server verification completed"

      - name: Check Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Verifying release assets..."
          gh release view ${{ github.ref_name }} --repo fulmenhq/brooklyn-mcp --json assets --jq '.assets | length'
          echo "Release asset verification completed"
          echo ""
          echo "NOTE: Signing artifacts will be uploaded separately."
          echo "  RELEASE_TAG=${{ github.ref_name }}"
          echo "  make release-download release-sign release-upload"
