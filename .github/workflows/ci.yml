# yamllint disable rule:document-start
# yamllint disable rule:truthy
name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-fast:
    name: Quality (fast)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      CI: true
      SKIP_BROWSER_CHECK: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Debug versions
        run: |
          set -euo pipefail
          bun --version
          node --version

      - name: Install Homebrew (Linux)
        run: |
          set -euo pipefail
          if ! command -v brew &> /dev/null; then
            echo "Installing Homebrew..."
            BREW_INSTALL="https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh"
            NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL $BREW_INSTALL)"
            echo "/home/linuxbrew/.linuxbrew/bin" >> "$GITHUB_PATH"
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          fi
          brew --version

      - name: Install minisign (brew - no sudo)
        run: |
          set -euo pipefail
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          if ! command -v minisign &> /dev/null; then
            brew install minisign
          fi
          minisign -v

      - name: Install goneat via sfetch (trust anchor)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # Ensure brew tools are in PATH for minisign
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)" || true
          curl -sSfL https://github.com/3leaps/sfetch/releases/latest/download/install-sfetch.sh | bash
          ~/.local/bin/sfetch -repo fulmenhq/goneat -tag v0.5.2 -install
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Verify goneat (minimum v0.5.2)
        run: |
          set -euo pipefail
          goneat --version
          # Verify minimum version v0.5.2 (required for tools.yaml min_version field)
          GONEAT_VERSION=$(goneat --version 2>&1 | head -n1 | \
            grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          REQUIRED_VERSION="v0.5.2"
          OLDEST=$(printf '%s\n' "$REQUIRED_VERSION" "$GONEAT_VERSION" | sort -V | head -n1)
          if [ "$OLDEST" != "$REQUIRED_VERSION" ]; then
            echo "❌ goneat $GONEAT_VERSION is below minimum required $REQUIRED_VERSION"
            exit 1
          fi
          echo "✅ goneat $GONEAT_VERSION meets minimum requirement ($REQUIRED_VERSION)"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install foundation tools (goneat doctor)
        run: |
          set -euo pipefail
          goneat doctor tools --scope foundation --install --install-package-managers --yes

      - name: Debug tool resolution
        run: |
          set -euo pipefail
          echo "PATH=$PATH"
          command -v prettier
          prettier --version
          command -v jq
          jq --version
          command -v yq || true
          yq --version || true
          command -v rg
          rg --version

      - name: Format (must be clean)
        run: |
          set -euo pipefail
          bun run format
          git diff --exit-code

      - name: Tool inventory up-to-date
        run: bun scripts/generate-tool-inventory.ts --check

      - name: Typecheck
        run: bun run typecheck

      - name: Embed version
        run: bun run version:embed

      - name: Lint
        run: bun run lint

      - name: Setup test infrastructure (dirs only)
        run: bun run setup:test-infra

      - name: Unit/precommit tests
        run: bun run test:precommit

  integration-build:
    name: Integration + build (browsers)
    needs: quality-fast
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      CI: true
      BROOKLYN_HEADLESS: "true"
      PLAYWRIGHT_HEADLESS: "true"
      BROOKLYN_CLEAN_BEFORE_TESTS: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Chromium (Playwright + OS deps)
        run: bunx playwright install --with-deps chromium --force

      - name: Debug Playwright cache
        run: |
          set -euo pipefail
          echo "Playwright cache structure:"
          find ~/.cache/ms-playwright -maxdepth 3 -type d 2>/dev/null || true
          echo "Looking for chrome binary:"
          find ~/.cache/ms-playwright -name "chrome" -type f 2>/dev/null || true
          find ~/.cache/ms-playwright -name "chromium" -type f 2>/dev/null || true

      - name: Setup test infrastructure
        run: bun run setup:test-infra

      - name: Integration tests
        run: bun run test:integration

      - name: Build (local)
        run: bun run build:local

      - name: Verify binary
        run: ./dist/brooklyn --version

      - name: Upload test logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: brooklyn-test-logs
          if-no-files-found: ignore
          path: |
            tmp/brooklyn-test/**
            tests/fixtures/logs/**
            /tmp/brooklyn-test-*.log
