name: Publish to npm
on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to publish (e.g. v0.3.3)"
        required: false
        type: string
      dry_run:
        description: "Dry run (validate but don't publish)"
        required: false
        type: boolean
        default: false
permissions:
  id-token: write  # Required for OIDC trusted publishing
  contents: read
jobs:
  publish:
    runs-on: ubuntu-latest
    environment: publish-npm  # Required for npm OIDC
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
      - name: Ensure npm supports OIDC
        run: |
          npm install -g npm@11.5.1
          echo "npm version: $(npm --version)"
      - name: Validate running from tag
        run: |
          if [ "${GITHUB_REF_TYPE:-}" != "tag" ]; then
            echo "::error::This workflow must run from a tag ref"
            exit 1
          fi
      - name: Validate versions match
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION_FILE=$(cat VERSION)
          VERSION_TAG="${TAG#v}"

          if [ "$VERSION_FILE" != "$VERSION_TAG" ]; then
            echo "::error::VERSION ($VERSION_FILE) != tag ($VERSION_TAG)"
            exit 1
          fi

          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$PKG_VERSION" != "$VERSION_TAG" ]; then
            echo "::error::package.json ($PKG_VERSION) != tag ($VERSION_TAG)"
            exit 1
          fi

          echo "version=${VERSION_TAG}" >> "$GITHUB_ENV"
      - name: Validate release is signed
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${GITHUB_REF_NAME}"

          # Check release is not draft
          DRAFT=$(gh release view "$TAG" --json isDraft --jq '.isDraft')
          if [ "$DRAFT" = "true" ]; then
            echo "::error::Release $TAG is still in draft. Complete signing first."
            exit 1
          fi

          # Check signature files exist (minisign required, GPG optional but expected)
          ASSETS=$(gh release view "$TAG" --json assets --jq '.assets[].name')

          # Required: minisign signatures
          for required in SHA256SUMS SHA256SUMS.minisig fulmenhq-release-minisign.pub; do
            if ! echo "$ASSETS" | grep -q "^${required}$"; then
              echo "::error::Missing required asset: $required"
              exit 1
            fi
          done

          # Check for GPG signatures (warn if missing)
          for gpg_asset in SHA256SUMS.asc fulmenhq-release-signing-key.asc; do
            if ! echo "$ASSETS" | grep -q "^${gpg_asset}$"; then
              echo "::warning::GPG asset not found: $gpg_asset"
            fi
          done

          echo "Release $TAG is signed and ready to publish"
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Quality checks
        run: bun run check-all
      - name: Publish (dry run)
        if: ${{ inputs.dry_run }}
        run: |
          unset NODE_AUTH_TOKEN NPM_TOKEN
          npm publish --dry-run
      - name: Publish
        if: ${{ !inputs.dry_run }}
        run: |
          unset NODE_AUTH_TOKEN NPM_TOKEN
          npm publish
      - name: Verify publication
        if: ${{ !inputs.dry_run }}
        run: |
          sleep 15
          npm view "brooklyn-mcp@${{ env.version }}" version || echo "::warning::Package not yet visible"
