#!/bin/sh

# Brooklyn Pre-push Hook
# Delegates to Makefile for FulmenHQ ecosystem consistency

echo "üåâ Brooklyn Pre-push Validation..."

# Detect platform and set binary path
BINARY_PATH="./dist/brooklyn"
if [ "$(uname -s)" = "MINGW64_NT" ] || [ "$(uname -s)" = "MSYS_NT" ]; then
  BINARY_PATH="./dist/brooklyn.exe"
fi

# First cleanup all Brooklyn services (if binary exists)
if [ -f "$BINARY_PATH" ]; then
  echo "üßπ Cleaning up Brooklyn services..."
  "$BINARY_PATH" cleanup --all || {
    echo "‚ö†Ô∏è  Warning: Cleanup failed, continuing anyway..."
  }
else
  echo "‚ö†Ô∏è  Note: Brooklyn binary not built yet, skipping cleanup"
fi

echo "üîç Running comprehensive pre-push validation..."
echo "   - Code quality checks (format, typecheck, lint)"
echo "   - Build artifacts validation"
echo "   - Full test suite"
echo "‚ö†Ô∏è  Note: Browser integration tests may fail if Playwright browsers are not installed."
echo "   Run 'make bootstrap' to install browsers for full testing."

# Set consistent environment variables for cross-platform testing
export BROOKLYN_HEADLESS=true
export PLAYWRIGHT_HEADLESS=true
export NODE_OPTIONS="--max-old-space-size=4096"

make prepush || {
  echo ""
  echo "‚ùå Pre-push validation failed. Please fix before pushing."
  echo ""
  echo "üí° Common fixes:"
  echo "   - Format issues: 'make fmt'"
  echo "   - Test failures: 'make test-unit' for unit tests only"
  echo "   - Build issues: 'make build' to check compilation"
  echo "   - Browser tests: 'make bootstrap' to install browsers"
  exit 1
}

# Run release validation for version tags
if echo "$1" | grep -q "refs/tags/v"; then
  echo "üè∑Ô∏è  Version tag detected - running release validation..."
  make release-check || {
    echo ""
    echo "‚ùå Release validation failed. Please fix before pushing version tag."
    echo ""
    echo "üí° Run 'make release-check' locally to see detailed validation results"
    exit 1
  }
  echo "‚úÖ Release validation passed!"
fi

echo "‚úÖ All pre-push checks passed!"
