#!/bin/sh

# Brooklyn Pre-push Hook
# Full validation suite including license scanning and integration tests

echo "ğŸŒ‰ Brooklyn Pre-push Validation..."

# First cleanup all Brooklyn services
echo "ğŸ§¹ Cleaning up Brooklyn services..."
brooklyn cleanup --all || {
  echo "âš ï¸  Warning: Cleanup failed, continuing anyway..."
}

# Run full prepush validation (includes license scanning)
echo "ğŸ” Running comprehensive pre-push validation..."
echo "   - Code quality checks (format, typecheck, lint)"
echo "   - License compliance scanning"
echo "   - Build artifacts validation"
echo "   - Full test suite"
echo "âš ï¸  Note: Browser integration tests may fail if Playwright browsers are not installed."
echo "   Run 'bun run setup:browsers' to install browsers for full testing."

bun run prepush || {
  echo ""
  echo "âŒ Pre-push validation failed. Please fix before pushing."
  echo ""
  echo "ğŸ’¡ Common fixes:"
  echo "   - Format issues: 'bun run format:code'"
  echo "   - License issues: Check 'dist/licenses/' output"
  echo "   - Test failures: 'bun run test:unit' for unit tests only"
  echo "   - Build issues: 'bun run build' to check compilation"
  echo "   - Browser tests: 'bun run setup:browsers' to install browsers"
  exit 1
}

# Run release validation for version tags
if echo "$1" | grep -q "refs/tags/v"; then
  echo "ğŸ·ï¸  Version tag detected - running release validation..."
  bun run release:validate || {
    echo ""
    echo "âŒ Release validation failed. Please fix before pushing version tag."
    echo ""
    echo "ğŸ’¡ Run 'bun run release:validate' locally to see detailed validation results"
    exit 1
  }
  echo "âœ… Release validation passed!"
fi

echo "âœ… All pre-push checks passed!"