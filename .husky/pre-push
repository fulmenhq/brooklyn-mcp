#!/bin/sh

# Brooklyn Pre-push Hook
# Full validation suite including license scanning and integration tests

echo "üåâ Brooklyn Pre-push Validation..."

# First cleanup all Brooklyn services
echo "üßπ Cleaning up Brooklyn services..."
brooklyn cleanup --all || {
  echo "‚ö†Ô∏è  Warning: Cleanup failed, continuing anyway..."
}

# Run full prepush validation (includes license scanning)
echo "üîç Running comprehensive pre-push validation..."
echo "   - Code quality checks (format, typecheck, lint)"
echo "   - License compliance scanning"
echo "   - Build artifacts validation"
echo "   - Full test suite"
echo "‚ö†Ô∏è  Note: Browser integration tests may fail if Playwright browsers are not installed."
echo "   Run 'bun run setup:browsers' to install browsers for full testing."
echo "‚è±Ô∏è  Expected duration: ~4 minutes on Windows"

# Set consistent environment variables for cross-platform testing
export BROOKLYN_HEADLESS=true
export PLAYWRIGHT_HEADLESS=true
export NODE_OPTIONS="--max-old-space-size=4096"

timeout 300 bun run prepush || {
  echo ""
  echo "‚ùå Pre-push validation failed. Please fix before pushing."
  echo ""
  echo "üí° Common fixes:"
  echo "   - Format issues: 'bun run format:code'"
  echo "   - License issues: Check 'dist/licenses/' output"
  echo "   - Test failures: 'bun run test:unit' for unit tests only"
  echo "   - Build issues: 'bun run build' to check compilation"
  echo "   - Browser tests: 'bun run setup:browsers' to install browsers"
  exit 1
}

# Run release validation for version tags
if echo "$1" | grep -q "refs/tags/v"; then
  echo "üè∑Ô∏è  Version tag detected - running release validation..."
  BROOKLYN_HEADLESS=true PLAYWRIGHT_HEADLESS=true NODE_OPTIONS="--max-old-space-size=4096" timeout 300 bun run release:validate || {
    echo ""
    echo "‚ùå Release validation failed. Please fix before pushing version tag."
    echo ""
    echo "üí° Run 'bun run release:validate' locally to see detailed validation results"
    exit 1
  }
  echo "‚úÖ Release validation passed!"
fi

echo "‚úÖ All pre-push checks passed!"