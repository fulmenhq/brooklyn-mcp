# Release Notes: v0.3.2

**Release Date**: 2026-02-01
**Release Type**: Patch Release - Security & Test Stability

## Highlights

- **Security**: Vitest 4.0.18 upgrade eliminates 94 Go stdlib CVEs from esbuild dependency chain
- **Test Stability**: stdout-purity tests now pass reliably in full suite with sysprims-backed cleanup
- **Process Management**: Tree-safe termination via sysprims integration for server operations
- **CI Hardening**: Browser version validation prevents Playwright revision drift

## Changes

### Security

- **Vitest 4.0.18 Upgrade**: Upgraded from vitest 2.x to 4.0.18, which ships with vite 7.x and modern esbuild compiled with Go 1.25.5 (previously Go 1.20.12)
  - Eliminated 94 vulnerabilities (6 critical, 34 high, 54 medium)
  - All Go stdlib CVEs from esbuild dependency chain resolved

### Fixed

- **stdout-purity Test Stability**: Tests now pass consistently in both isolation and full suite
  - Root cause: Timing race where stdin.end() terminated transport before response flush
  - Fix: ID-based stdin closure waits for all expected JSON-RPC response IDs
  - Added vitest workspace to isolate process-spawning tests
  - Switched to sysprims-backed cleanup (terminateTree) instead of brittle `lsof | kill -9`

- **Process Management**: Hardened stop flows and PID file handling
  - Graceful shutdown with configurable timeouts
  - Proper cleanup of stale PID files

- **CI Workflow**: Resolved yamllint and shellcheck warnings
  - Fixed long lines in browser validation script
  - Replaced `ls | grep` patterns with proper globs (SC2010)

### Added

- **sysprims Integration for Server Ops**: Native process management support
  - `terminateTree`: Tree-safe process termination
  - `processList`: Structured process discovery
  - `listeningPorts`: Port-to-PID attribution
  - Falls back to legacy ps/grep when sysprims unavailable

- **Browser Version Consistency Validation**
  - CI job validates installed Playwright browser revisions match package expectations
  - Unit tests catch version drift before CI failures
  - Documents browser update procedure

- **Vitest Workspace Configuration**: Process-spawning tests run in dedicated project
  - `maxWorkers: 1` for stdout-purity and version-command tests
  - Prevents state pollution between test suites

### Changed

- **Vitest Config Migration**: Updated for vitest 4.x compatibility
  - `poolOptions.forks.singleFork` → `maxWorkers: 1` (top-level)
  - Arrow function constructor mocks → function syntax (vitest 4.x requirement)

- **Documentation**: Consolidated decision records into `docs/decisions/`

## Quality Metrics

| Metric | Before | After |
|--------|--------|-------|
| Vulnerabilities | 94 | 0 |
| Test Pass Rate | ~92% (intermittent) | 100% |
| Tests Passing | 1237 | 1241 |
| Test Files | 67 | 67 |
| Lint Health | 86% | 100% |

## Breaking Changes

None. This is a fully backward-compatible patch release.

## Upgrade Notes

```bash
# Update to v0.3.2
bun update brooklyn-mcp

# If using vitest in your own tests, note that vitest 4.x has breaking changes:
# - Arrow function constructor mocks must use function() syntax
# - poolOptions.forks removed - use top-level maxWorkers
```

## Contributors

- CI/CD automation with Claude Code assistance

## Links

- [Changelog](../../CHANGELOG.md)
- [vitest 4.x Migration Guide](https://vitest.dev/guide/migration)
- [sysprims Documentation](../../src/shared/sysprims.ts)
