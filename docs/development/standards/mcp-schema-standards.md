\n# MCP JSON Schema Standards\n\n**Version**: 1.0.0 \n**Status**: Active \n**Category**: Development Standards \n**Tags**: [mcp, json-schema, claude-code, compatibility, tool-definitions]\n\n---\n\n## Overview\n\nThis document defines JSON Schema standards for MCP (Model Context Protocol) tool definitions to ensure compatibility across different MCP clients, particularly Claude Code. These standards prevent schema validation errors and ensure consistent tool behavior.\n\n## Critical Client Compatibility Requirements\n\n### Claude Code Restrictions\n\n**üö® BREAKING CONSTRAINT**: Claude Code does not support `oneOf`, `allOf`, or `anyOf` at the **top level** of tool input schemas.\n\n`typescript\n// ‚ùå FORBIDDEN - Will cause API Error 400\ninputSchema: {\n  type: \"object\",\n  properties: { /* ... */ },\n  anyOf: [{ required: [\"fieldA\"] }, { required: [\"fieldB\"] }], // ‚ùå Top-level constraint\n}\n\n// ‚úÖ CORRECT - Alternative approaches\ninputSchema: {\n  type: \"object\",\n  properties: {\n    fieldA: {\n      type: \"string\",\n      description: \"Field A (optional if fieldB provided)\",\n    },\n    fieldB: {\n      type: \"string\", \n      description: \"Field B (optional if fieldA provided)\",\n    },\n  },\n  // Move validation logic to server-side implementation\n}\n`\n\n### Nested Schema Constraints\n\n`typescript\n// ‚úÖ ALLOWED - oneOf/anyOf within property definitions\nproperties: {\n  target: {\n    oneOf: [ // ‚úÖ OK within property\n      { enum: [\"latest\", \"current\"] },\n      { pattern: \"^browser-[a-zA-Z0-9]+$\" }\n    ]\n  }\n}\n`\n\n## Brooklyn Schema Standards\n\n### 1. Tool Definition Structure\n\n`typescript\ninterface EnhancedTool extends Tool {\n  name: string;                    // Tool identifier\n  category: string;                // Organizational category\n  description: string;             // Clear, action-oriented description\n  inputSchema: JSONSchema7;        // Claude Code compatible schema\n  examples?: ToolExample[];        // Usage examples (highly recommended)\n  errors?: ToolError[];           // Common error scenarios\n}\n`\n\n### 2. Parameter Design Patterns\n\n#### Optional Parameter Pattern\n`typescript\n// For tools that accept either parameter A or B\n{\n  name: \"flexible_tool\",\n  description: \"Tool description. Either 'paramA' or 'paramB' must be provided.\",\n  inputSchema: {\n    type: \"object\",\n    properties: {\n      paramA: {\n        type: \"string\",\n        description: \"Parameter A (optional if paramB provided)\",\n      },\n      paramB: {\n        type: \"string\", \n        description: \"Parameter B (optional if paramA provided)\",\n      },\n    },\n    // No required array - validation handled server-side\n  },\n}\n`\n\n#### Browser Targeting Pattern\n`typescript\n// Standard pattern for browser-related tools\n{\n  properties: {\n    browserId: {\n      type: \"string\",\n      description: \"Optional. ID of the browser. If omitted or invalid, the server will resolve based on 'target'.\",\n    },\n    target: {\n      type: \"string\",\n      enum: [\"latest\", \"current\", \"byId\"],\n      description: \"Optional targeting strategy when browserId is omitted or invalid.\",\n      default: \"latest\",\n    },\n  },\n}\n`\n\n### 3. Description Standards\n\n#### Action-Oriented Descriptions\n`typescript\n// ‚úÖ GOOD - Clear action and context\n\"Navigate browser to a specific URL and wait for page load\"\n\"Capture a screenshot and store as file to avoid MCP token limits\"\n\"Extract text content from an element using CSS selector\"\n\n// ‚ùå AVOID - Vague or technical jargon\n\"URL navigation functionality\"\n\"Screenshot utility\"  \n\"Text extraction\"\n`\n\n#### Parameter Descriptions\n`typescript\nproperties: {\n  selector: {\n    type: \"string\",\n    description: \"CSS selector for element to capture (optional)\", // Clear purpose and optionality\n  },\n  timeout: {\n    type: \"number\",\n    description: \"Timeout in milliseconds\", // Include units\n    default: 5000,                        // Show defaults\n    minimum: 100,                         // Include constraints\n    maximum: 30000,\n  },\n}\n`\n\n### 4. Category System\n\n**Standard Categories:**\n- `browser-lifecycle` - Launch, close, manage browsers\n- `navigation` - URL navigation, history management \n- `content-capture` - Screenshots, page content extraction\n- `interaction` - Clicking, form filling, waiting\n- `discovery` - Tool help, capability discovery\n\n`typescript\n// Category naming convention: lowercase-with-hyphens\nexport const contentCaptureTools: EnhancedTool[] = [\n  {\n    name: \"take_screenshot\",\n    category: \"content-capture\", // Consistent category\n    // ...\n  },\n];\n`\n\n## Schema Validation Patterns\n\n### 1. Type Safety\n`typescript\n// ‚úÖ STRICT - Use specific types\ntype: \"string\" | \"number\" | \"boolean\" | \"object\" | \"array\"\n\n// ‚ùå AVOID - Generic types\ntype: \"any\"\n`\n\n### 2. Enum Constraints\n`typescript\n// ‚úÖ GOOD - Explicit allowed values\nbrowserType: {\n  type: \"string\",\n  enum: [\"chromium\", \"firefox\", \"webkit\"],\n  description: \"Browser engine to launch\",\n  default: \"chromium\",\n}\n\n// ‚ùå AVOID - Open-ended strings without validation\nbrowserType: {\n  type: \"string\",\n  description: \"Browser type\", // Too vague, no constraints\n}\n`\n\n### 3. Numeric Constraints\n`typescript\nquality: {\n  type: \"number\",\n  description: \"JPEG quality (1-100, ignored for PNG)\",\n  minimum: 1,      // Always specify ranges\n  maximum: 100,\n  default: 90,\n}\n`\n\n### 4. Object Properties\n`typescript\nviewport: {\n  type: \"object\",\n  properties: {\n    width: { type: \"number\", default: 1280 },\n    height: { type: \"number\", default: 720 },\n  },\n  description: \"Browser viewport dimensions\",\n  // additionalProperties: false, // Consider for strict validation\n}\n`\n\n## Testing and Validation\n\n### 1. Schema Validation Testing\n`typescript\n// Test schema compatibility\ndescribe(\"MCP Schema Compatibility\", () => {\n  test(\"tools should not use top-level anyOf/oneOf/allOf\", () => {\n    const tools = getAllTools();\n    \n    tools.forEach(tool => {\n      const schema = tool.inputSchema;\n      expect(schema).not.toHaveProperty(\"anyOf\");\n      expect(schema).not.toHaveProperty(\"oneOf\"); \n      expect(schema).not.toHaveProperty(\"allOf\");\n    });\n  });\n  \n  test(\"all tools should have valid JSON schema\", () => {\n    const tools = getAllTools();\n    const validator = ajv.compile(metaSchema);\n    \n    tools.forEach(tool => {\n      const isValid = validator(tool.inputSchema);\n      expect(isValid).toBe(true);\n    });\n  });\n});\n`\n\n### 2. Claude Code Compatibility Testing\n`bash\n# Manual testing process\nbun run build && bun run install\nclaude mcp remove brooklyn  \nclaude mcp add -s user brooklyn brooklyn mcp start\nclaude mcp list  # Should show no errors\n\n# Test in Claude Code with any command\n# Should not see \"oneOf, allOf, or anyOf\" errors\n`\n\n### 3. Tool Definition Validation\n``typescript\n// Validate tool definitions at build time\nexport function validateToolDefinitions(tools: EnhancedTool[]): void {\n  tools.forEach(tool => {\n    // Check required fields\n    if (!tool.name || !tool.category || !tool.description) {\n      throw new Error(`Invalid tool definition: ${tool.name}`);\n    }\n    \n    // Check schema compliance\n    validateSchemaCompliance(tool.inputSchema);\n    \n    // Check examples if provided\n    if (tool.examples) {\n      validateExamples(tool, tool.examples);\n    }\n  });\n}\n``\n\n## Migration Guidelines\n\n### From Constrained Schemas\nWhen migrating existing tools with `anyOf`/`oneOf`/`allOf` constraints:\n\n1. **Document requirements in description**:\n `typescript\n   description: \"Tool description. Either 'paramA' or 'paramB' must be provided.\"\n   `\n\n2. **Make parameters optional in schema**:\n `typescript\n   // Remove from required array, handle validation server-side\n   `\n\n3. **Add server-side validation**:\n `typescript\n   function validateInput(input: ToolInput): void {\n     if (!input.paramA && !input.paramB) {\n       throw new Error(\"Either paramA or paramB must be provided\");\n     }\n   }\n   `\n\n### Schema Evolution\n`typescript\n// Version your schemas for major changes\ninterface ToolSchemaV1 {\n  // Original schema\n}\n\ninterface ToolSchemaV2 {\n  // Updated schema with backward compatibility\n}\n\n// Maintain compatibility handlers\nfunction migrateSchemaV1ToV2(input: ToolSchemaV1): ToolSchemaV2 {\n  // Migration logic\n}\n`\n\n## Common Anti-Patterns\n\n### 1. ‚ùå Top-Level Constraints\n`typescript\n// FORBIDDEN\ninputSchema: {\n  anyOf: [{ required: [\"path\"] }, { required: [\"auditId\"] }]\n}\n`\n\n### 2. ‚ùå Vague Descriptions \n`typescript\n// BAD\ndescription: \"Does something with browser\"\n\n// GOOD  \ndescription: \"Navigate browser to a specific URL and wait for page load\"\n`\n\n### 3. ‚ùå Missing Parameter Context\n`typescript\n// BAD\nbrowserId: {\n  type: \"string\",\n  description: \"Browser ID\", \n}\n\n// GOOD\nbrowserId: {\n  type: \"string\", \n  description: \"Optional. ID of the browser. If omitted or invalid, the server will resolve based on 'target'.\",\n}\n`\n\n### 4. ‚ùå Inconsistent Categorization\n`typescript\n// BAD - Mixed naming conventions\ncategory: \"Browser_Lifecycle\"  // PascalCase\ncategory: \"content capture\"    // spaces\ncategory: \"nav\"               // abbreviation\n\n// GOOD - Consistent kebab-case  \ncategory: \"browser-lifecycle\"\ncategory: \"content-capture\"\ncategory: \"navigation\"\n`\n\n## Best Practices Summary\n\n1. **‚úÖ Never use `anyOf`/`oneOf`/`allOf` at top level of inputSchema**\n2. **‚úÖ Move complex validation to server-side implementation** \n3. **‚úÖ Use clear, action-oriented descriptions**\n4. **‚úÖ Specify parameter optionality and relationships**\n5. **‚úÖ Include examples for complex tools**\n6. **‚úÖ Use consistent category naming (kebab-case)**\n7. **‚úÖ Add numeric constraints (min/max/default)**\n8. **‚úÖ Test schema compatibility during CI/CD**\n9. **‚úÖ Document migration paths for breaking changes**\n10. **‚úÖ Validate all tool definitions at build time**\n\n## Error Codes and Solutions\n\n| Error | Cause | Solution |\n|-------|-------|----------|\n| `oneOf, allOf, or anyOf at the top level` | Top-level schema constraint | Move to server-side validation |\n| `Invalid JSON Schema` | Malformed schema structure | Validate with JSON Schema validator |\n| `Tool not found` | Missing tool in category exports | Check `getAllTools()` includes tool |\n| `Parameter validation failed` | Server-side validation error | Check parameter requirements in description |\n\n## Related Documentation\n\n- [Tool Implementation Standards](./tool-implementation-standards.md)\n- [MCP Protocol Documentation](https://modelcontextprotocol.io/)\n- [JSON Schema Specification](https://json-schema.org/)\n- [Brooklyn Tool Definitions](../../../src/core/tool-definitions.ts)\n\n---\n\n**Compliance Note**: All Brooklyn MCP tools must follow these standards. Schema validation is enforced during build process and CI/CD pipeline.\n\n**Last Updated**: 2025-01-20 by Paris Brooklyn üåâ \n**Review Cycle**: Monthly during Architecture Committee meetings\n
